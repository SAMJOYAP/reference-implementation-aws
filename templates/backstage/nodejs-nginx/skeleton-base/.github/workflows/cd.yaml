name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:

jobs:
  publish-ecr:
    name: Build and Push to ECR
    if: (github.event_name == 'workflow_dispatch') || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' && github.event.workflow_run.actor.login != 'github-actions[bot]')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: read
    env:
      AWS_REGION: {% raw %}${{ secrets.AWS_REGION }}{% endraw %}
      ECR_REPOSITORY: {% raw %}${{ github.event.repository.name }}{% endraw %}
      GITOPS_REPO: ${{ values.gitopsOwner }}/${{ values.gitopsRepo }}
      APP_NAME: ${{ values.name }}
      APP_HOST: ${{ values.hostPrefix }}.${{ values.baseDomain }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve image version from git tag
        id: version
        shell: bash
        run: |
          if git tag --list | grep -q .; then
            VERSION_TAG="$(git describe --tags --always --dirty=-dev)"
            VERSION_TAG="${VERSION_TAG#v}"
          else
            VERSION_TAG="1.0.0"
          fi
          SHA_TAG="${GITHUB_SHA::7}"
          echo "version_tag=${VERSION_TAG}" >> "$GITHUB_OUTPUT"
          echo "sha_tag=${SHA_TAG}" >> "$GITHUB_OUTPUT"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: {% raw %}${{ secrets.AWS_ROLE_ARN }}{% endraw %}
          aws-region: {% raw %}${{ env.AWS_REGION }}{% endraw %}

      - name: Ensure ECR repository exists
        shell: bash
        run: |
          aws ecr describe-repositories --repository-names "$ECR_REPOSITORY" >/dev/null 2>&1 || \
          aws ecr create-repository --repository-name "$ECR_REPOSITORY" >/dev/null

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        env:
          REGISTRY: {% raw %}${{ steps.login-ecr.outputs.registry }}{% endraw %}
          VERSION_TAG: {% raw %}${{ steps.version.outputs.version_tag }}{% endraw %}
          SHA_TAG: {% raw %}${{ steps.version.outputs.sha_tag }}{% endraw %}
        run: |
          IMAGE_URI="$REGISTRY/$ECR_REPOSITORY"
          docker build -t "$IMAGE_URI:$VERSION_TAG" -t "$IMAGE_URI:$SHA_TAG" .
          docker push "$IMAGE_URI:$VERSION_TAG"
          docker push "$IMAGE_URI:$SHA_TAG"

      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: ${{ values.gitopsOwner }}/${{ values.gitopsRepo }}
          token: {% raw %}${{ secrets.GITOPS_REPO_TOKEN }}{% endraw %}
          ref: main
          path: gitops-repo

      - name: Bootstrap app manifests in GitOps repo
        shell: bash
        run: |
          APP_DIR="gitops-repo/apps/$APP_NAME"
          MANIFEST_DIR="$APP_DIR/manifests"
          mkdir -p "$MANIFEST_DIR"

          if [ ! -f "$APP_DIR/kustomization.yaml" ]; then
            cat > "$APP_DIR/kustomization.yaml" <<YAML
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - manifests/namespace.yaml
  - manifests/service.yaml
  - manifests/deployment.yaml
  - manifests/ingress.yaml
YAML
          fi

          if [ ! -f "$MANIFEST_DIR/namespace.yaml" ]; then
            cat > "$MANIFEST_DIR/namespace.yaml" <<YAML
apiVersion: v1
kind: Namespace
metadata:
  name: $APP_NAME
  labels:
    app.kubernetes.io/name: $APP_NAME
YAML
          fi

          if [ ! -f "$MANIFEST_DIR/service.yaml" ]; then
            cat > "$MANIFEST_DIR/service.yaml" <<YAML
apiVersion: v1
kind: Service
metadata:
  name: $APP_NAME
  namespace: $APP_NAME
  labels:
    app.kubernetes.io/name: $APP_NAME
spec:
  selector:
    app.kubernetes.io/name: $APP_NAME
  ports:
    - name: http
      port: 80
      targetPort: 80
      protocol: TCP
  type: ClusterIP
YAML
          fi

          if [ ! -f "$MANIFEST_DIR/deployment.yaml" ]; then
            cat > "$MANIFEST_DIR/deployment.yaml" <<YAML
apiVersion: apps/v1
kind: Deployment
metadata:
  name: $APP_NAME
  namespace: $APP_NAME
  labels:
    app.kubernetes.io/name: $APP_NAME
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: $APP_NAME
  template:
    metadata:
      labels:
        app.kubernetes.io/name: $APP_NAME
    spec:
      containers:
        - name: app
          image: nginx:1.27-alpine
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 80
YAML
          fi

          if [ ! -f "$MANIFEST_DIR/ingress.yaml" ]; then
            cat > "$MANIFEST_DIR/ingress.yaml" <<YAML
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: $APP_NAME
  namespace: $APP_NAME
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  ingressClassName: nginx
  rules:
    - host: $APP_HOST
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: $APP_NAME
                port:
                  number: 80
  tls:
    - hosts:
        - $APP_HOST
      secretName: $APP_NAME-tls
YAML
          fi

      - name: Update GitOps deployment image tag
        env:
          REGISTRY: {% raw %}${{ steps.login-ecr.outputs.registry }}{% endraw %}
          VERSION_TAG: {% raw %}${{ steps.version.outputs.version_tag }}{% endraw %}
        shell: bash
        run: |
          IMAGE_URI="$REGISTRY/$ECR_REPOSITORY:$VERSION_TAG"
          DEPLOYMENT_FILE="gitops-repo/apps/$APP_NAME/manifests/deployment.yaml"
          sed -i -E "s|(^[[:space:]]*image:[[:space:]]*).*$|\1$IMAGE_URI|" "$DEPLOYMENT_FILE"

      - name: Check GitOps manifest changes
        id: manifest_changes
        shell: bash
        run: |
          if git -C gitops-repo diff --quiet -- "apps/$APP_NAME"; then
            echo "No manifest changes detected."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Create pull request in GitOps repo
        id: create_pr
        if: steps.manifest_changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: {% raw %}${{ secrets.GITOPS_REPO_TOKEN }}{% endraw %}
          path: gitops-repo
          commit-message: "chore(cd): update ${{ values.name }} image tag [skip ci]"
          title: "chore(cd): update ${{ values.name }} image tag"
          body: |
            Automated GitOps manifest update from `${{ values.name }}` CD workflow.
          branch: chore/cd-update-image-${{ values.name }}
          base: main
          delete-branch: true
          add-paths: |
            apps/${{ values.name }}/kustomization.yaml
            apps/${{ values.name }}/manifests/namespace.yaml
            apps/${{ values.name }}/manifests/service.yaml
            apps/${{ values.name }}/manifests/deployment.yaml
            apps/${{ values.name }}/manifests/ingress.yaml

      - name: Enable auto-merge for GitOps PR
        if: steps.manifest_changes.outputs.changed == 'true' && steps.create_pr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: {% raw %}${{ secrets.GITOPS_REPO_TOKEN }}{% endraw %}
          PR_NUMBER: {% raw %}${{ steps.create_pr.outputs.pull-request-number }}{% endraw %}
        shell: bash
        run: |
          gh pr merge "$PR_NUMBER" --auto --squash --repo "$GITOPS_REPO"
