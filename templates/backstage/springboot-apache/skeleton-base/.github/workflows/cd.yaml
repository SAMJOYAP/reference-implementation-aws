name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:

jobs:
  publish-ecr:
    name: Build and Push to ECR
    if: (github.event_name == 'workflow_dispatch') || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' && github.event.workflow_run.actor.login != 'github-actions[bot]')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      pull-requests: write
    env:
      AWS_REGION: {% raw %}${{ secrets.AWS_REGION }}{% endraw %}
      ECR_REPOSITORY: {% raw %}${{ github.event.repository.name }}{% endraw %}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '${{ values.javaVersion }}'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '${{ values.gradleVersion }}'

      - name: Build artifact
        run: gradle clean build --no-daemon

      - name: Resolve image version from git tag
        id: version
        shell: bash
        run: |
          if git tag --list | grep -q .; then
            VERSION_TAG="$(git describe --tags --always --dirty=-dev)"
            VERSION_TAG="${VERSION_TAG#v}"
          else
            VERSION_TAG="1.0.0"
          fi
          SHA_TAG="${GITHUB_SHA::7}"
          echo "version_tag=${VERSION_TAG}" >> "$GITHUB_OUTPUT"
          echo "sha_tag=${SHA_TAG}" >> "$GITHUB_OUTPUT"

      - name: Normalize runtime artifact
        shell: bash
        run: |
          APP_FILE="$(find build/libs -maxdepth 1 -type f \( -name '*.jar' -o -name '*.war' \) | head -n 1)"
          if [ -z "$APP_FILE" ]; then
            echo "No jar/war artifact found in build/libs"
            exit 1
          fi
          cp "$APP_FILE" build/libs/app-runtime.jar

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: {% raw %}${{ secrets.AWS_ROLE_ARN }}{% endraw %}
          aws-region: {% raw %}${{ env.AWS_REGION }}{% endraw %}

      - name: Ensure ECR repository exists
        shell: bash
        run: |
          aws ecr describe-repositories --repository-names "$ECR_REPOSITORY" >/dev/null 2>&1 || \
          aws ecr create-repository --repository-name "$ECR_REPOSITORY" >/dev/null

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        env:
          REGISTRY: {% raw %}${{ steps.login-ecr.outputs.registry }}{% endraw %}
          VERSION_TAG: {% raw %}${{ steps.version.outputs.version_tag }}{% endraw %}
          SHA_TAG: {% raw %}${{ steps.version.outputs.sha_tag }}{% endraw %}
        run: |
          IMAGE_URI="$REGISTRY/$ECR_REPOSITORY"
          docker build -t "$IMAGE_URI:$VERSION_TAG" -t "$IMAGE_URI:$SHA_TAG" .
          docker push "$IMAGE_URI:$VERSION_TAG"
          docker push "$IMAGE_URI:$SHA_TAG"

      - name: Update deployment image tag
        env:
          REGISTRY: {% raw %}${{ steps.login-ecr.outputs.registry }}{% endraw %}
          VERSION_TAG: {% raw %}${{ steps.version.outputs.version_tag }}{% endraw %}
        shell: bash
        run: |
          IMAGE_URI="$REGISTRY/$ECR_REPOSITORY:$VERSION_TAG"
          sed -i -E "s|(^[[:space:]]*image:[[:space:]]*).*$|\1$IMAGE_URI|" manifests/deployment.yaml

      - name: Check manifest changes
        id: manifest_changes
        shell: bash
        run: |
          if git diff --quiet -- manifests/deployment.yaml; then
            echo "No manifest changes detected."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Create pull request for manifest update
        if: steps.manifest_changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: chore(cd): update image tag [skip ci]
          title: chore(cd): update image tag
          body: |
            Automated manifest image tag update from CD workflow.
          branch: chore/cd-update-image
          base: main
          delete-branch: true
          add-paths: |
            manifests/deployment.yaml
