name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  publish-ecr:
    name: Build and Push to ECR
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      ECR_REPOSITORY: ${{ github.event.repository.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '${{ values.javaVersion }}'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '${{ values.gradleVersion }}'

      - name: Build artifact
        run: gradle clean build --no-daemon

      - name: Resolve image version from git tag
        id: version
        shell: bash
        run: |
          VERSION_TAG="$(git describe --tags --always --dirty=-dev)"
          VERSION_TAG="${VERSION_TAG#v}"
          SHA_TAG="${GITHUB_SHA::7}"
          echo "version_tag=${VERSION_TAG}" >> "$GITHUB_OUTPUT"
          echo "sha_tag=${SHA_TAG}" >> "$GITHUB_OUTPUT"

      - name: Normalize runtime artifact
        shell: bash
        run: |
          APP_FILE="$(find build/libs -maxdepth 1 -type f \( -name '*.jar' -o -name '*.war' \) | head -n 1)"
          if [ -z "$APP_FILE" ]; then
            echo "No jar/war artifact found in build/libs"
            exit 1
          fi
          cp "$APP_FILE" build/libs/app-runtime.jar

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure ECR repository exists
        shell: bash
        run: |
          aws ecr describe-repositories --repository-names "$ECR_REPOSITORY" >/dev/null 2>&1 || \
          aws ecr create-repository --repository-name "$ECR_REPOSITORY" >/dev/null

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          VERSION_TAG: ${{ steps.version.outputs.version_tag }}
          SHA_TAG: ${{ steps.version.outputs.sha_tag }}
        run: |
          IMAGE_URI="$REGISTRY/$ECR_REPOSITORY"
          docker build -t "$IMAGE_URI:$VERSION_TAG" -t "$IMAGE_URI:$SHA_TAG" .
          docker push "$IMAGE_URI:$VERSION_TAG"
          docker push "$IMAGE_URI:$SHA_TAG"

      - name: Update deployment image tag
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          VERSION_TAG: ${{ steps.version.outputs.version_tag }}
        shell: bash
        run: |
          IMAGE_URI="$REGISTRY/$ECR_REPOSITORY:$VERSION_TAG"
          sed -i -E "s|(^[[:space:]]*image:[[:space:]]*).*$|\1$IMAGE_URI|" manifests/deployment.yaml

      - name: Commit and push manifest update
        shell: bash
        run: |
          if git diff --quiet -- manifests/deployment.yaml; then
            echo "No manifest changes detected."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add manifests/deployment.yaml
          git commit -m "chore(cd): update image tag [skip ci]"
          git push
